open! Core
open Hardcaml
open Problem_4
open Hardcaml_waveterm
include Util

let run_test_case
      ?(print_waves = false)
      (case_name : string)
      (vector_size : int)
      (test_input : int list list)
  =
  let module Forklift_cfg : Sliding_window_intf.Config = struct
    let data_vector_size = vector_size
  end
  in
  let module Sw = Forklift.Make (Forklift_cfg) in
  let module Dut = Solver.Make (Sw) in
  let module Sim = Cyclesim.With_interface (Dut.I) (Dut.O) in
  let oc =
    concat_test_suite_and_case_name "solver-test" case_name
    |> to_vcd_dump
    |> Out_channel.create
  in
  Exn.protect
    ~f:(fun () ->
      let sim = Vcd.wrap oc @@ Sim.create @@ Dut.create (Scope.create ()) in
      let waves, sim = Waveform.create sim in
      let i = Cyclesim.inputs sim in
      let o = Cyclesim.outputs sim in
      let rec run_until_finished sim =
        if Bits.to_int !(o.finished) <> 1 then (
          next_cycle sim;
          run_until_finished sim)
      in
      let num_rows = List.length test_input in
      let num_cols = List.length @@ List.hd_exn @@ test_input in
      i.num_rows := Bits.of_int num_rows ~width:Dut.input_row_bit_width;
      i.num_cols := Bits.of_int num_cols ~width:Dut.input_col_bit_width;
      i.enable := Bits.vdd;
      i.data_valid := Bits.vdd;
      i.clear := Bits.gnd;
      next_cycle ~n:2 sim;
      let feed_input c =
        i.data_in := Bits.of_int c ~width:Dut.data_vector_size;
        i.data_valid := Bits.vdd;
        next_cycle sim
      in
      List.iter test_input ~f:(fun r -> List.iter r ~f:feed_input);
      i.data_in := Bits.gnd;
      next_cycle ~n:30 sim;
      i.data_valid := Bits.gnd;
      run_until_finished sim;
      let actual = Bits.to_int !(o.total_removed_paper_count) in
      Stdio.printf "%s: %d\n" case_name actual;
      if print_waves then
        Waveform.print ~display_width:200 ~display_height:60 ~start_cycle:20 waves;
      next_cycle sim)
    ~finally:(fun () -> Out_channel.close oc)
;;

let%expect_test "AoC Day 4 Test Input (10x10)" =
  let vector_size = 1 in
  run_test_case
    ~print_waves:true
    "Simple Input 1 (3x3)"
    vector_size
    [ [ 0; 1; 1 ]; [ 0; 1; 1 ]; [ 1; 0; 1 ] ];
  [%expect
    {|
    Simple Input 1 (3x3): 6
    ┌Signals───────────┐┌Waves─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │clock             ││┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌─│
    │                  ││    └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘ │
    │clear             ││                                                                                                                                                                                  │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │enable            ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││                                                                                                                                                                                  │
    │data_in           ││                                                                                                                                                                                  │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │data_valid        ││────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐         │
    │                  ││                                                                                                                                                                        └─────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │num_cols          ││ 03                                                                                                                                                                               │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │num_rows          ││ 03                                                                                                                                                                               │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │dbg_wp_i$clear    ││                                                                                                                                                                                  │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │dbg_wp_i$clock    ││                                                                                                                                                                                  │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │dbg_wp_i$col_size ││ 03                                                                                                                                                                               │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │dbg_wp_i$data_in  ││                        ┌───────────────┐                                                                                                                                         │
    │                  ││────────────────────────┘               └─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │dbg_wp_i$data_in_v││────────────────────────────────────────────────────────────────┐                                                               ┌─────────────────────────────────────────────────│
    │                  ││                                                                └───────────────────────────────────────────────────────────────┘                                                 │
    │dbg_wp_i$enable   ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││                                                                                                                                                                                  │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │dbg_wp_i$row_size ││ 03                                                                                                                                                                               │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │dbg_wp_i$start    ││                                                                                                                        ┌───────┐                                                 │
    │                  ││────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘       └─────────────────────────────────────────────────│
    │dbg_wp_o$data_out ││                                                                                                                                                                                  │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │dbg_wp_o$data_out_││                                                ┌───────────────────────────────────────────────────────────────────────┐                                                         │
    │                  ││────────────────────────────────────────────────┘                                                                       └─────────────────────────────────────────────────────────│
    │dbg_wp_o$idle     ││                                                                                                                        ┌───────┐                                                 │
    │                  ││────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘       └─────────────────────────────────────────────────│
    │dbg_wp_o$last_in  ││                                                        ┌───────┐                                                                                                                 │
    │                  ││────────────────────────────────────────────────────────┘       └─────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │dbg_wp_o$last_out ││                                                                                                                ┌───────┐                                                         │
    │                  ││────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘       └─────────────────────────────────────────────────────────│
    │dbg_wp_o$ready    ││────────────────────────────────────────────────────────────────┐                                                               ┌─────────────────────────────────────────────────│
    │                  ││                                                                └───────────────────────────────────────────────────────────────┘                                                 │
    │                  ││────────────────────────────────────────────────────────────────────────────────┬───────┬───────────────────────────────────────┬─────────────────────────────────────────────────│
    │dbg_wp_o$total_cou││ 00000                                                                          │00001  │00002                                  │00000                                            │
    │                  ││────────────────────────────────────────────────────────────────────────────────┴───────┴───────────────────────────────────────┴─────────────────────────────────────────────────│
    │finished          ││                                                                                                                                                                                  │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┬─────────────────────────────────────────────────────────│
    │total_removed_pape││ 00004                                                                                                                  │00006                                                    │
    │                  ││────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┴─────────────────────────────────────────────────────────│
    │                  ││                                                                                                                                                                                  │
    │                  ││                                                                                                                                                                                  │
    │                  ││                                                                                                                                                                                  │
    │                  ││                                                                                                                                                                                  │
    └──────────────────┘└──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  run_test_case
    "Simple Input 2 (3x3)"
    vector_size
    [ [ 1; 1; 1 ]; [ 1; 1; 1 ]; [ 1; 1; 1 ] ];
  [%expect {| Simple Input 2 (3x3): 9 |}];
  run_test_case
    ~print_waves:true
    "Diamond Shape (4x4)"
    vector_size
    [ [ 1; 1; 1; 1 ]; [ 1; 1; 1; 1 ]; [ 1; 1; 1; 1 ]; [ 1; 1; 1; 1 ] ];
  [%expect
    {|
    Diamond Shape (4x4): 4
    ┌Signals───────────┐┌Waves─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
    │clock             ││┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌───┐   ┌─│
    │                  ││    └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘   └───┘ │
    │clear             ││                                                                                                                                                                                  │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │enable            ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││                                                                                                                                                                                  │
    │data_in           ││                                                                                                                                                                                  │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │data_valid        ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││                                                                                                                                                                                  │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │num_cols          ││ 04                                                                                                                                                                               │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │num_rows          ││ 04                                                                                                                                                                               │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │dbg_wp_i$clear    ││                                                                                                                                                                                  │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │dbg_wp_i$clock    ││                                                                                                                                                                                  │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │dbg_wp_i$col_size ││ 04                                                                                                                                                                               │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │dbg_wp_i$data_in  ││                                                                ┌───────────────┐       ┌───────────────────────────────────────────────────────────────┐       ┌───────────────┐ │
    │                  ││────────────────────────────────────────────────────────────────┘               └───────┘                                                               └───────┘               └─│
    │dbg_wp_i$data_in_v││                                                        ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││────────────────────────────────────────────────────────┘                                                                                                                         │
    │dbg_wp_i$enable   ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││                                                                                                                                                                                  │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │dbg_wp_i$row_size ││ 04                                                                                                                                                                               │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │dbg_wp_i$start    ││                                                ┌───────┐                                                                                                                         │
    │                  ││────────────────────────────────────────────────┘       └─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │dbg_wp_o$data_out ││────────────────┐       ┌───────────────┐                                                                                       ┌───────────────┐       ┌─────────────────────────│
    │                  ││                └───────┘               └───────────────────────────────────────────────────────────────────────────────────────┘               └───────┘                         │
    │dbg_wp_o$data_out_││────────────────────────────────────────────────┐                                                                       ┌─────────────────────────────────────────────────────────│
    │                  ││                                                └───────────────────────────────────────────────────────────────────────┘                                                         │
    │dbg_wp_o$idle     ││                                                ┌───────┐                                                                                                                         │
    │                  ││────────────────────────────────────────────────┘       └─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │dbg_wp_o$last_in  ││                                                                                                                                                                                ┌─│
    │                  ││────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘ │
    │dbg_wp_o$last_out ││                                        ┌───────┐                                                                                                                                 │
    │                  ││────────────────────────────────────────┘       └─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │dbg_wp_o$ready    ││                                                        ┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││────────────────────────────────────────────────────────┘                                                                                                                         │
    │                  ││────────────────┬───────────────────────┬───────────────┬─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │dbg_wp_o$total_cou││ 00002          │00003                  │00004          │00000                                                                                                                    │
    │                  ││────────────────┴───────────────────────┴───────────────┴─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │finished          ││                                                                                                                                                                                  │
    │                  ││──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││────────────────────────────────────────────────┬─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │total_removed_pape││ 00000                                          │00004                                                                                                                            │
    │                  ││────────────────────────────────────────────────┴─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────│
    │                  ││                                                                                                                                                                                  │
    │                  ││                                                                                                                                                                                  │
    │                  ││                                                                                                                                                                                  │
    │                  ││                                                                                                                                                                                  │
    └──────────────────┘└──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
    |}];
  run_test_case
    "AoC Day 4 Test Input (10x10)"
    vector_size
    (read_input "inputs/day4_test.txt");
  [%expect {| AoC Day 4 Test Input (10x10): 43 |}];
  run_test_case
    "AoC Day 4 Real Input (100x100)"
    vector_size
    (read_input "inputs/day4_real.txt");
  [%expect {| AoC Day 4 Real Input (100x100): 8690 |}]
;;
