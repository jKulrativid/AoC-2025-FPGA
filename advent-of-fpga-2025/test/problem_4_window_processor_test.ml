open! Base
open Hardcaml
open Hardcaml_waveterm
open Problem_4
include Util

(* TODO: adopt test harness for verifying enable and clear logic *)

let parse_simple_grid str : int list list =
  String.split_lines str
  |> List.map ~f:String.strip
  |> List.filter ~f:(fun s -> String.length s > 0)
  |> List.map ~f:(fun line ->
    String.split line ~on:' '
    |> List.filter ~f:(fun s -> String.length s > 0)
    |> List.map ~f:(function
      | "x" | "X" -> 0
      | s -> Int.of_string s))
;;

let run_test_case ?(print_waves = false) (case_name : string) (grid : int list list) =
  let rows = List.length grid in
  let cols = List.length (List.hd_exn grid) in
  let module Forklift_cfg : Sliding_window_intf.Config = struct
    let data_vector_size = 1
  end
  in
  let module Window_processor_cfg = struct
    let input_row_bit_width = 16
    let input_col_bit_width = 16
  end
  in
  let module Sliding_window = Forklift.Make (Forklift_cfg) in
  let module Dut = Window_processor.Make (Window_processor_cfg) (Sliding_window) in
  let module Sim = Cyclesim.With_interface (Dut.I) (Dut.O) in
  let sim = Sim.create (Dut.create (Scope.create ~flatten_design:true ())) in
  let waves, sim = Waveform.create sim in
  let i = Cyclesim.inputs sim in
  let o = Cyclesim.outputs sim in
  i.clear := Bits.vdd;
  i.enable := Bits.vdd;
  next_cycle sim;
  i.clear := Bits.gnd;
  i.start := Bits.vdd;
  i.row_size := Bits.of_int ~width:Dut.input_row_bit_width rows;
  i.col_size := Bits.of_int ~width:Dut.input_col_bit_width cols;
  next_cycle sim;
  i.start := Bits.gnd;
  List.iter grid ~f:(fun row ->
    List.iter row ~f:(fun pixel ->
      let rec wait_for_ready safety =
        if safety = 0 then
          failwith "Timeout waiting for Ready";
        if Bits.to_bool !(o.ready) then
          ()
        else (
          next_cycle sim;
          wait_for_ready (safety - 1))
      in
      wait_for_ready 100;
      i.data_in := Bits.of_int ~width:1 pixel;
      i.data_in_valid := Bits.vdd;
      next_cycle sim));
  i.data_in_valid := Bits.gnd;
  let rec drain limit =
    if limit = 0 then
      failwith "Timeout draining pipeline";
    if Bits.to_bool !(o.last) then
      ()
    else (
      next_cycle sim;
      drain (limit - 1))
  in
  drain ((rows * cols * 4) + 10) (* MAGIC! *);
  let result = Bits.to_int !(o.total_count) in
  Stdio.printf "%s: %d\n" case_name result;
  next_cycle
    ~n:3
    sim (* sim 3 cycle to check the behavior with circuit become idle again *);
  if print_waves then
    let open Display_rule in
    let rules =
      [ port_name_is "clock"
      ; port_name_is "idle"
      ; port_name_is "ready"
      ; port_name_matches (Re.Posix.compile_pat "data_in.*")
      ; port_name_matches (Re.Posix.compile_pat "data_out.*")
      ; port_name_is "last"
      ; port_name_is "total_count" ~wave_format:Unsigned_int
      ]
    in
    Waveform.print
      ~wave_width:1
      ~display_width:100
      ~display_height:30
      ~display_rules:rules
      waves
;;

let%expect_test "1x1" =
  run_test_case "zero" ~print_waves:true (parse_simple_grid {|0|});
  [%expect
    {|
    zero: 0
    ┌Signals───────────┐┌Waves─────────────────────────────────────────────────────────────────────────┐
    │clock             ││┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─│
    │                  ││  └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ │
    │                  ││────────┬───────────────────────┬───────                                      │
    │idle              ││ 1      │0                      │1                                            │
    │                  ││────────┴───────────────────────┴───────                                      │
    │                  ││────────┬───┬───────────────────────────                                      │
    │ready             ││ 0      │1  │0                                                                │
    │                  ││────────┴───┴───────────────────────────                                      │
    │                  ││────────────────────────────────────────                                      │
    │data_in           ││ 0                                                                            │
    │                  ││────────────────────────────────────────                                      │
    │                  ││────────┬───┬───────────────────────────                                      │
    │data_in_valid     ││ 0      │1  │0                                                                │
    │                  ││────────┴───┴───────────────────────────                                      │
    │                  ││────────────────────────────────────────                                      │
    │data_out          ││ 0                                                                            │
    │                  ││────────────────────────────────────────                                      │
    │                  ││────────────────────────────┬───┬───────                                      │
    │data_out_valid    ││ 0                          │1  │0                                            │
    │                  ││────────────────────────────┴───┴───────                                      │
    │                  ││────────────────────────────┬───┬───────                                      │
    │last              ││ 0                          │1  │0                                            │
    │                  ││────────────────────────────┴───┴───────                                      │
    │                  ││────────────────────────────────────────                                      │
    │total_count       ││ 0                                                                            │
    │                  ││────────────────────────────────────────                                      │
    │                  ││                                                                              │
    │                  ││                                                                              │
    └──────────────────┘└──────────────────────────────────────────────────────────────────────────────┘
    |}];
  run_test_case "one" ~print_waves:true (parse_simple_grid {|1|});
  [%expect
    {|
    one: 1
    ┌Signals───────────┐┌Waves─────────────────────────────────────────────────────────────────────────┐
    │clock             ││┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─│
    │                  ││  └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ │
    │                  ││────────┬───────────────────────┬───────                                      │
    │idle              ││ 1      │0                      │1                                            │
    │                  ││────────┴───────────────────────┴───────                                      │
    │                  ││────────┬───┬───────────────────────────                                      │
    │ready             ││ 0      │1  │0                                                                │
    │                  ││────────┴───┴───────────────────────────                                      │
    │                  ││────────┬───────────────────────────────                                      │
    │data_in           ││ 0      │1                                                                    │
    │                  ││────────┴───────────────────────────────                                      │
    │                  ││────────┬───┬───────────────────────────                                      │
    │data_in_valid     ││ 0      │1  │0                                                                │
    │                  ││────────┴───┴───────────────────────────                                      │
    │                  ││────────────────────────────────────────                                      │
    │data_out          ││ 0                                                                            │
    │                  ││────────────────────────────────────────                                      │
    │                  ││────────────────────────────┬───┬───────                                      │
    │data_out_valid    ││ 0                          │1  │0                                            │
    │                  ││────────────────────────────┴───┴───────                                      │
    │                  ││────────────────────────────┬───┬───────                                      │
    │last              ││ 0                          │1  │0                                            │
    │                  ││────────────────────────────┴───┴───────                                      │
    │                  ││────────────────────────────┬───────────                                      │
    │total_count       ││ 0                          │1                                                │
    │                  ││────────────────────────────┴───────────                                      │
    │                  ││                                                                              │
    │                  ││                                                                              │
    └──────────────────┘└──────────────────────────────────────────────────────────────────────────────┘
    |}]
;;

(* TODO: 2x2 and some rectangular shapes *)

let%expect_test "3x3" =
  run_test_case
    "all zero"
    ~print_waves:true
    (parse_simple_grid
       {|
        0 0 0
        0 0 0
        0 0 0
      |});
  [%expect
    {|
    all zero: 0
    ┌Signals───────────┐┌Waves─────────────────────────────────────────────────────────────────────────┐
    │clock             ││┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─│
    │                  ││  └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ │
    │                  ││────────┬───────────────────────────────────────────────────────────────┬─────│
    │idle              ││ 1      │0                                                              │1    │
    │                  ││────────┴───────────────────────────────────────────────────────────────┴─────│
    │                  ││────────┬───────────────────────────────────┬─────────────────────────────────│
    │ready             ││ 0      │1                                  │0                                │
    │                  ││────────┴───────────────────────────────────┴─────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────│
    │data_in           ││ 0                                                                            │
    │                  ││──────────────────────────────────────────────────────────────────────────────│
    │                  ││────────┬───────────────────────────────────┬─────────────────────────────────│
    │data_in_valid     ││ 0      │1                                  │0                                │
    │                  ││────────┴───────────────────────────────────┴─────────────────────────────────│
    │                  ││──────────────────────────────────────────────────────────────────────────────│
    │data_out          ││ 0                                                                            │
    │                  ││──────────────────────────────────────────────────────────────────────────────│
    │                  ││────────────────────────────────────┬───────────────────────────────────┬─────│
    │data_out_valid    ││ 0                                  │1                                  │0    │
    │                  ││────────────────────────────────────┴───────────────────────────────────┴─────│
    │                  ││────────────────────────────────────────────────────────────────────┬───┬─────│
    │last              ││ 0                                                                  │1  │0    │
    │                  ││────────────────────────────────────────────────────────────────────┴───┴─────│
    │                  ││──────────────────────────────────────────────────────────────────────────────│
    │total_count       ││ 0                                                                            │
    │                  ││──────────────────────────────────────────────────────────────────────────────│
    │                  ││                                                                              │
    │                  ││                                                                              │
    └──────────────────┘└──────────────────────────────────────────────────────────────────────────────┘
    |}];
  run_test_case
    "all one"
    ~print_waves:true
    (parse_simple_grid
       {|
        1 1 1
        1 1 1
        1 1 1
      |});
  [%expect
    {|
    all one: 4
    ┌Signals───────────┐┌Waves─────────────────────────────────────────────────────────────────────────┐
    │clock             ││┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─│
    │                  ││  └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ │
    │                  ││────────┬───────────────────────────────────────────────────────────────┬─────│
    │idle              ││ 1      │0                                                              │1    │
    │                  ││────────┴───────────────────────────────────────────────────────────────┴─────│
    │                  ││────────┬───────────────────────────────────┬─────────────────────────────────│
    │ready             ││ 0      │1                                  │0                                │
    │                  ││────────┴───────────────────────────────────┴─────────────────────────────────│
    │                  ││────────┬─────────────────────────────────────────────────────────────────────│
    │data_in           ││ 0      │1                                                                    │
    │                  ││────────┴─────────────────────────────────────────────────────────────────────│
    │                  ││────────┬───────────────────────────────────┬─────────────────────────────────│
    │data_in_valid     ││ 0      │1                                  │0                                │
    │                  ││────────┴───────────────────────────────────┴─────────────────────────────────│
    │                  ││────────────────────────────────────────┬───┬───┬───────────┬───┬───┬─────────│
    │data_out          ││ 0                                      │1  │0  │1          │0  │1  │0        │
    │                  ││────────────────────────────────────────┴───┴───┴───────────┴───┴───┴─────────│
    │                  ││────────────────────────────────────┬───────────────────────────────────┬─────│
    │data_out_valid    ││ 0                                  │1                                  │0    │
    │                  ││────────────────────────────────────┴───────────────────────────────────┴─────│
    │                  ││────────────────────────────────────────────────────────────────────┬───┬─────│
    │last              ││ 0                                                                  │1  │0    │
    │                  ││────────────────────────────────────────────────────────────────────┴───┴─────│
    │                  ││────────────────────────────────────┬───────┬───────────────┬───────┬─────────│
    │total_count       ││ 0                                  │1      │2              │3      │4        │
    │                  ││────────────────────────────────────┴───────┴───────────────┴───────┴─────────│
    │                  ││                                                                              │
    │                  ││                                                                              │
    └──────────────────┘└──────────────────────────────────────────────────────────────────────────────┘
    |}];
  run_test_case
    "diamond"
    ~print_waves:true
    (parse_simple_grid
       {|
        0 1 0
        1 1 1
        0 1 0
      |});
  [%expect
    {|
    diamond: 4
    ┌Signals───────────┐┌Waves─────────────────────────────────────────────────────────────────────────┐
    │clock             ││┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─│
    │                  ││  └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ │
    │                  ││────────┬───────────────────────────────────────────────────────────────┬─────│
    │idle              ││ 1      │0                                                              │1    │
    │                  ││────────┴───────────────────────────────────────────────────────────────┴─────│
    │                  ││────────┬───────────────────────────────────┬─────────────────────────────────│
    │ready             ││ 0      │1                                  │0                                │
    │                  ││────────┴───────────────────────────────────┴─────────────────────────────────│
    │                  ││────────────┬───┬───┬───────────┬───┬───┬─────────────────────────────────────│
    │data_in           ││ 0          │1  │0  │1          │0  │1  │0                                    │
    │                  ││────────────┴───┴───┴───────────┴───┴───┴─────────────────────────────────────│
    │                  ││────────┬───────────────────────────────────┬─────────────────────────────────│
    │data_in_valid     ││ 0      │1                                  │0                                │
    │                  ││────────┴───────────────────────────────────┴─────────────────────────────────│
    │                  ││────────────────────────────────────────────────────┬───┬─────────────────────│
    │data_out          ││ 0                                                  │1  │0                    │
    │                  ││────────────────────────────────────────────────────┴───┴─────────────────────│
    │                  ││────────────────────────────────────┬───────────────────────────────────┬─────│
    │data_out_valid    ││ 0                                  │1                                  │0    │
    │                  ││────────────────────────────────────┴───────────────────────────────────┴─────│
    │                  ││────────────────────────────────────────────────────────────────────┬───┬─────│
    │last              ││ 0                                                                  │1  │0    │
    │                  ││────────────────────────────────────────────────────────────────────┴───┴─────│
    │                  ││────────────────────────────────────────┬───────┬───────┬───────┬─────────────│
    │total_count       ││ 0                                      │1      │2      │3      │4            │
    │                  ││────────────────────────────────────────┴───────┴───────┴───────┴─────────────│
    │                  ││                                                                              │
    │                  ││                                                                              │
    └──────────────────┘└──────────────────────────────────────────────────────────────────────────────┘
    |}];
  run_test_case
    "partial 1"
    ~print_waves:true
    (parse_simple_grid
       {|
        0 0 0
        1 1 1
        1 1 0
      |});
  [%expect
    {|
    partial 1: 3
    ┌Signals───────────┐┌Waves─────────────────────────────────────────────────────────────────────────┐
    │clock             ││┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─│
    │                  ││  └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ │
    │                  ││────────┬───────────────────────────────────────────────────────────────┬─────│
    │idle              ││ 1      │0                                                              │1    │
    │                  ││────────┴───────────────────────────────────────────────────────────────┴─────│
    │                  ││────────┬───────────────────────────────────┬─────────────────────────────────│
    │ready             ││ 0      │1                                  │0                                │
    │                  ││────────┴───────────────────────────────────┴─────────────────────────────────│
    │                  ││────────────────────┬───────────────────┬─────────────────────────────────────│
    │data_in           ││ 0                  │1                  │0                                    │
    │                  ││────────────────────┴───────────────────┴─────────────────────────────────────│
    │                  ││────────┬───────────────────────────────────┬─────────────────────────────────│
    │data_in_valid     ││ 0      │1                                  │0                                │
    │                  ││────────┴───────────────────────────────────┴─────────────────────────────────│
    │                  ││────────────────────────────────────────────────────┬───┬───────┬───┬─────────│
    │data_out          ││ 0                                                  │1  │0      │1  │0        │
    │                  ││────────────────────────────────────────────────────┴───┴───────┴───┴─────────│
    │                  ││────────────────────────────────────┬───────────────────────────────────┬─────│
    │data_out_valid    ││ 0                                  │1                                  │0    │
    │                  ││────────────────────────────────────┴───────────────────────────────────┴─────│
    │                  ││────────────────────────────────────────────────────────────────────┬───┬─────│
    │last              ││ 0                                                                  │1  │0    │
    │                  ││────────────────────────────────────────────────────────────────────┴───┴─────│
    │                  ││────────────────────────────────────────────────┬───────┬───┬─────────────────│
    │total_count       ││ 0                                              │1      │2  │3                │
    │                  ││────────────────────────────────────────────────┴───────┴───┴─────────────────│
    │                  ││                                                                              │
    │                  ││                                                                              │
    └──────────────────┘└──────────────────────────────────────────────────────────────────────────────┘
    |}];
  run_test_case
    "partial 2"
    ~print_waves:true
    (parse_simple_grid
       {|
        1 1 0
        1 0 1
        1 1 0
      |});
  [%expect
    {|
    partial 2: 5
    ┌Signals───────────┐┌Waves─────────────────────────────────────────────────────────────────────────┐
    │clock             ││┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─│
    │                  ││  └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ │
    │                  ││────────┬───────────────────────────────────────────────────────────────┬─────│
    │idle              ││ 1      │0                                                              │1    │
    │                  ││────────┴───────────────────────────────────────────────────────────────┴─────│
    │                  ││────────┬───────────────────────────────────┬─────────────────────────────────│
    │ready             ││ 0      │1                                  │0                                │
    │                  ││────────┴───────────────────────────────────┴─────────────────────────────────│
    │                  ││────────┬───────┬───┬───┬───┬───────────┬─────────────────────────────────────│
    │data_in           ││ 0      │1      │0  │1  │0  │1          │0                                    │
    │                  ││────────┴───────┴───┴───┴───┴───────────┴─────────────────────────────────────│
    │                  ││────────┬───────────────────────────────────┬─────────────────────────────────│
    │data_in_valid     ││ 0      │1                                  │0                                │
    │                  ││────────┴───────────────────────────────────┴─────────────────────────────────│
    │                  ││────────────────────────────────────────────────┬───┬─────────────────────────│
    │data_out          ││ 0                                              │1  │0                        │
    │                  ││────────────────────────────────────────────────┴───┴─────────────────────────│
    │                  ││────────────────────────────────────┬───────────────────────────────────┬─────│
    │data_out_valid    ││ 0                                  │1                                  │0    │
    │                  ││────────────────────────────────────┴───────────────────────────────────┴─────│
    │                  ││────────────────────────────────────────────────────────────────────┬───┬─────│
    │last              ││ 0                                                                  │1  │0    │
    │                  ││────────────────────────────────────────────────────────────────────┴───┴─────│
    │                  ││────────────────────────────────────┬───┬───────────────┬───┬───┬─────────────│
    │total_count       ││ 0                                  │1  │2              │3  │4  │5            │
    │                  ││────────────────────────────────────┴───┴───────────────┴───┴───┴─────────────│
    │                  ││                                                                              │
    │                  ││                                                                              │
    └──────────────────┘└──────────────────────────────────────────────────────────────────────────────┘
    |}];
  run_test_case
    "almost full"
    ~print_waves:true
    (parse_simple_grid
       {|
        1 1 1
        1 1 1
        1 0 1
      |});
  [%expect
    {|
    almost full: 4
    ┌Signals───────────┐┌Waves─────────────────────────────────────────────────────────────────────────┐
    │clock             ││┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─┐ ┌─│
    │                  ││  └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ └─┘ │
    │                  ││────────┬───────────────────────────────────────────────────────────────┬─────│
    │idle              ││ 1      │0                                                              │1    │
    │                  ││────────┴───────────────────────────────────────────────────────────────┴─────│
    │                  ││────────┬───────────────────────────────────┬─────────────────────────────────│
    │ready             ││ 0      │1                                  │0                                │
    │                  ││────────┴───────────────────────────────────┴─────────────────────────────────│
    │                  ││────────┬───────────────────────────┬───┬─────────────────────────────────────│
    │data_in           ││ 0      │1                          │0  │1                                    │
    │                  ││────────┴───────────────────────────┴───┴─────────────────────────────────────│
    │                  ││────────┬───────────────────────────────────┬─────────────────────────────────│
    │data_in_valid     ││ 0      │1                                  │0                                │
    │                  ││────────┴───────────────────────────────────┴─────────────────────────────────│
    │                  ││────────────────────────────────────────┬───┬───┬───────────┬─────────────────│
    │data_out          ││ 0                                      │1  │0  │1          │0                │
    │                  ││────────────────────────────────────────┴───┴───┴───────────┴─────────────────│
    │                  ││────────────────────────────────────┬───────────────────────────────────┬─────│
    │data_out_valid    ││ 0                                  │1                                  │0    │
    │                  ││────────────────────────────────────┴───────────────────────────────────┴─────│
    │                  ││────────────────────────────────────────────────────────────────────┬───┬─────│
    │last              ││ 0                                                                  │1  │0    │
    │                  ││────────────────────────────────────────────────────────────────────┴───┴─────│
    │                  ││────────────────────────────────────┬───────┬───────────────┬───────┬─────────│
    │total_count       ││ 0                                  │1      │2              │3      │4        │
    │                  ││────────────────────────────────────┴───────┴───────────────┴───────┴─────────│
    │                  ││                                                                              │
    │                  ││                                                                              │
    └──────────────────┘└──────────────────────────────────────────────────────────────────────────────┘
    |}]
;;

let%expect_test "AoC Input" =
  run_test_case "AoC Day 4 Test Input (10x10)" (read_input "inputs/day4_test.txt");
  [%expect {| AoC Day 4 Test Input (10x10): 13 |}];
  run_test_case "AoC Day 4 Real Input (100x100)" (read_input "inputs/day4_real.txt");
  [%expect {| AoC Day 4 Real Input (100x100): 1527 |}]
;;
